{% macro renderNode(node, session) %}
<div class="tree-node" id="node-{{ node.id }}" style="margin: 10px 0; padding: 10px; border-left: 3px solid {% if node.cluster_id %}{{ getClusterColour(session, node.cluster_id) }}{% else %}#b1b4b6{% endif %}; background-color: {{ getAgencyBackground(node.agency) }};">
  <div style="margin-bottom: 5px;">
    <strong class="govuk-tag govuk-tag--grey level-indicator" style="font-size: 0.75rem;">Level {{ node.level }}</strong>
    {% if node.cluster_id %}
      <strong class="govuk-tag" style="background-color: {{ getClusterColour(session, node.cluster_id) }}; font-size: 0.75rem;">
        {{ getClusterLabel(session, node.cluster_id) }}
      </strong>
    {% endif %}
    {% if node.agency %}
      <strong class="govuk-tag" style="background-color: {{ getAgencyColour(node.agency) }}; font-size: 0.75rem; color: {% if node.agency == 'high' %}#fff{% else %}#0b0c0c{% endif %};">
        {{ getAgencyLabel(node.agency) }}
      </strong>
    {% endif %}
  </div>
  
  {% if editNodeId and editNodeId == node.id %}
    <form action="/session/{{ session.id }}/node/{{ node.id }}/update-text" method="post" class="govuk-!-margin-bottom-2">
      {{ govukInput({
        id: 'text-' + node.id,
        name: 'text',
        label: { text: 'Edit response', classes: 'govuk-label--s' },
        classes: 'govuk-!-width-full',
        value: node.text
      }) }}
      <div class="govuk-button-group">
        {{ govukButton({ text: 'Save' }) }}
        <a href="/session/{{ session.id }}/workspace#node-{{ node.id }}" class="govuk-link">Cancel</a>
      </div>
    </form>
  {% else %}
    <p class="govuk-body" style="margin-bottom: 10px;">{{ node.text }} <a href="/session/{{ session.id }}/workspace?editNode={{ node.id }}#node-{{ node.id }}" class="govuk-link govuk-!-font-size-14 node-edit-link">edit</a></p>
  {% endif %}
  
  <div class="govuk-button-group">
    {# "Why else" adds a sibling by adding a child to this node's parent #}
    {% if node.parent_id %}
      <a href="/session/{{ session.id }}/add-response?parentId={{ node.parent_id }}&mode=why_else" class="govuk-link govuk-!-font-size-14">And why else do you think?</a>
    {% endif %}
    {# "Why is that" deepens this branch (adds a child to this node) #}
    <a href="/session/{{ session.id }}/node/{{ node.id }}/deepen" class="govuk-link govuk-!-font-size-14">Why is that?</a>
    {% if node.parent_id %}
      <a href="/session/{{ session.id }}/node/{{ node.id }}/delete" class="govuk-link govuk-!-font-size-14" onclick="return confirm('Delete this node and its sub-branches?');">Delete node</a>
    {% endif %}
    {% if session.clusters and session.clusters.length > 0 %}
    <a href="/session/{{ session.id }}/node/{{ node.id }}/cluster" class="govuk-link govuk-!-font-size-14">Assign cluster</a>
    {% endif %}
    <a href="/session/{{ session.id }}/node/{{ node.id }}/agency" class="govuk-link govuk-!-font-size-14">Set agency</a>
  </div>
  
  {% if node.children and node.children.length > 0 %}
  <div style="margin-left: 20px; margin-top: 15px;">
    {% for childNode in node.children %}
      {{ renderNode(childNode, session) }}
    {% endfor %}
  </div>
  {% endif %}
</div>
{% endmacro %}

{% if tree %}
  {{ renderNode(tree, session) }}
{% endif %}
