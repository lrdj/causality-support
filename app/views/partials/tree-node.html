{% macro renderNode(node, session) %}
<div class="tree-node" style="margin: 10px 0; padding: 10px; border-left: 3px solid {% if node.cluster_id %}{{ getClusterColour(session, node.cluster_id) }}{% else %}#b1b4b6{% endif %}; background-color: #f3f2f1;">
  <div style="margin-bottom: 5px;">
    <strong class="govuk-tag govuk-tag--grey" style="font-size: 0.75rem;">Level {{ node.level }}</strong>
    {% if node.cluster_id %}
      <strong class="govuk-tag" style="background-color: {{ getClusterColour(session, node.cluster_id) }}; font-size: 0.75rem;">
        {{ getClusterLabel(session, node.cluster_id) }}
      </strong>
    {% endif %}
  </div>
  
  <p class="govuk-body" style="margin-bottom: 10px;">{{ node.text }}</p>
  
  <div class="govuk-button-group">
    {# "Why else" adds a sibling by adding a child to this node's parent #}
    {% if node.parent_id %}
      <a href="/session/{{ session.id }}/add-response?parentId={{ node.parent_id }}&mode=why_else" class="govuk-link govuk-!-font-size-14">And why else do you think?</a>
    {% endif %}
    {# "Why is that" deepens this branch (adds a child to this node) #}
    <a href="/session/{{ session.id }}/node/{{ node.id }}/deepen" class="govuk-link govuk-!-font-size-14">Why is that?</a>
    {% if session.clusters and session.clusters.length > 0 %}
    <a href="/session/{{ session.id }}/node/{{ node.id }}/cluster" class="govuk-link govuk-!-font-size-14">Assign cluster</a>
    {% endif %}
  </div>
  
  {% if node.children and node.children.length > 0 %}
  <div style="margin-left: 20px; margin-top: 15px;">
    {% for childNode in node.children %}
      {{ renderNode(childNode, session) }}
    {% endfor %}
  </div>
  {% endif %}
</div>
{% endmacro %}

{% if tree %}
  {{ renderNode(tree, session) }}
{% endif %}
